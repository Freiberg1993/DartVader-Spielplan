<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DartVader Turnierplan ‚Äì Fairplay strikt (gespielt statt geplant)</title>
  <style>
    :root{ --bg:#0f1419; --panel:#15202b; --panel-2:#1e2933; --text:#e6edf3; --muted:#94a3b8; --accent:#38bdf8; --danger:#ef4444; --table:#0b1220; --border:#203040; }
    *{box-sizing:border-box}
    body{margin:0; background:var(--bg); color:var(--text); font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif}
    header{padding:20px 24px; border-bottom:1px solid var(--border); background:linear-gradient(180deg, rgba(56,189,248,.15), transparent)}
    h1{margin:0 0 6px; font-size:28px}
    h2{margin:10px 0 0; font-size:22px}
    h3{margin:16px 0 8px; font-size:18px}
    h4{margin:14px 0 6px; font-size:16px}
    .grid{display:grid; grid-template-columns:1fr; gap:16px; padding:16px}
    @media(min-width:960px){.grid{grid-template-columns:1.1fr .9fr}}
    .card{background:var(--panel); border:1px solid var(--border); border-radius:12px; padding:16px}
    .muted{color:var(--muted)}
    button{background:var(--accent); color:#04243b; border:0; border-radius:8px; padding:8px 12px; font-weight:600; cursor:pointer}
    button.secondary{background:var(--panel-2); color:var(--text); border:1px solid #264055}
    button.danger{background:var(--danger); color:#fff}
    input, select{background:#0b1620; color:var(--text); border:1px solid #22364a; border-radius:8px; padding:8px; min-height:38px}
    input[type=number]{width:120px}
    input[type=date]{width:170px}
    table{width:100%; border-collapse:separate; border-spacing:0; margin-top:10px}
    th, td{padding:10px 12px; border-bottom:1px solid #1f2d3a}
    th{background:var(--table); text-align:left}
    tr:hover{background:#0f1b28}
    .row-actions{display:flex; gap:8px}
    .pill{display:inline-block; padding:4px 8px; border-radius:999px; background:#0b1620; border:1px solid #22364a}
    .flex{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .spacer{flex:1}
    .draggable{cursor:grab}
    .dragging{opacity:.55}
    footer{padding:16px; color:var(--muted)}
  </style>
</head>
<body>
  <header>
    <h1>DartVader Turnierplan ‚Äì Fairplay strikt (gespielt statt geplant)</h1>
    <h2>DartVader Turnierplan</h2>
    <p>Fairplay-Regeln STRIKT: niemand spielt 2√ó in Folge, niemand wartet 3√ó in Folge. R√ºckrunde automatisch; Grenze konfliktfrei.</p>
    <p class="muted">‚ö°Ô∏è Fairplay aktiv</p>
  </header>

  <main class="grid">
    <!-- Teilnehmer -->
    <section class="card">
      <h3>Teilnehmer</h3>
      <div class="flex">
        <button id="addPlayerBtn">‚ûï Spieler hinzuf√ºgen</button>
        <button id="resetStatsBtn" class="secondary">üßπ Ergebnisse zur√ºcksetzen</button>
        <input id="newPlayerInput" type="text" placeholder="Name" />
      </div>
      <p class="muted">Tipp: Namen doppelklicken zum Bearbeiten.</p>
      <table id="playersTable">
        <thead>
          <tr>
            <th>Name</th>
            <th>Gespielt</th>
            <th>Siege</th>
            <th>Niederlagen</th>
            <th>Aktion</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>

    <!-- Spielplan -->
    <section class="card">
      <h3>Spielplan</h3>
      <div class="flex">
        <button id="genFairBtn">üîÅ Zuf√§llige Paarungen (FAIR, strikt)</button>
        <button id="shuffleFairBtn" class="secondary">üîÄ Reihenfolge mischen (FAIR beibehalten)</button>
        <div class="spacer"></div>
        <span class="muted">(Zeilen in den Tabellen sind per Drag & Drop verschiebbar)</span>
      </div>

      <h4>Hinrunde</h4>
      <table id="hinTable">
        <thead>
          <tr>
            <th>#</th>
            <th>Spieler A</th>
            <th>Spieler B</th>
            <th>Sieger</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <h4>R√ºckrunde</h4>
      <table id="rueckTable">
        <thead>
          <tr>
            <th>#</th>
            <th>Spieler A</th>
            <th>Spieler B</th>
            <th>Sieger</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <p class="muted">Made for DartVader ‚Ä¢ Lokale Speicherung aktiv</p>
    </section>

    <!-- Tages-H√∂chstwurf -->
    <section class="card">
      <h3>üèÜ Tages‚ÄëH√∂chstwurf</h3>
      <p class="muted">Erfasse den h√∂chsten Wurf des Tages (0‚Äì1000). Eintr√§ge werden lokal im Browser gespeichert.</p>
      <div class="flex">
        <label>Datum<br><input id="maxThrowDate" type="date"></label>
        <label>Teilnehmer<br><select id="maxThrowPlayer"></select></label>
        <label>Wurf<br><input id="maxThrowValue" type="number" min="0" max="1000" step="1" placeholder="0‚Äì1000"></label>
        <button id="saveMaxThrowBtn">üíæ Speichern</button>
        <button id="clearMaxThrowsBtn" class="danger">üóëÔ∏è Alle l√∂schen</button>
      </div>
      <h4>Letzte Eintr√§ge</h4>
      <table id="maxThrowsTable">
        <thead>
          <tr>
            <th>Datum</th>
            <th>Teilnehmer</th>
            <th>Wurf</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>

    <!-- Turnier-Gewinner -->
    <section class="card">
      <h3>üìà Turnier‚ÄëGewinner‚ÄëStatistik</h3>
      <p class="muted">Trage ein, wer an welchem Datum das Turnier gewonnen hat. Optik & Bedienung wie beim H√∂chstwurf‚ÄëWidget.</p>
      <div class="flex">
        <label>Datum<br><input id="winnerDate" type="date"></label>
        <label>Gewinner<br><select id="winnerPlayer"></select></label>
        <button id="saveWinnerBtn">üíæ Speichern</button>
        <button id="clearWinnersBtn" class="danger">üóëÔ∏è Alle l√∂schen</button>
      </div>
      <h4>Historie</h4>
      <table id="winnersTable">
        <thead>
          <tr>
            <th>Datum</th>
            <th>Gewinner</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>

    <!-- Permalink Sync (Option 2) -->
    <section class="card">
      <h3>üì¶ Daten‚ÄëSync (Permalink)</h3>
      <p class="muted">Erzeuge einen Link mit allen Daten (Spieler, Spielplan, H√∂chstwurf, Gewinner), um sie auf anderen Ger√§ten zu laden.</p>
      <div class="flex">
        <button id="permCreateBtn" class="secondary">Permalink kopieren</button>
        <span id="permInfo" class="muted" style="font-size:12px"></span>
      </div>
      <p class="muted" style="font-size:12px">Hinweis: localStorage ist pro Ger√§t/Browser. Mit dem Permalink kannst du Daten auf einem anderen Ger√§t laden.</p>
    </section>
  </main>

  <footer>
    <span class="muted">¬© DartVader ‚Äì lokal gespeichert in deinem Browser.</span>
  </footer>

  <script>
    // ---------- Storage Keys ----------
    var K_PLAYERS = 'dv_players';
    var K_STATS   = 'dv_stats';
    var K_S_HIN   = 'dv_schedule_hin';
    var K_S_RUECK = 'dv_schedule_rueck';
    var K_MAX     = 'dv_maxthrows';
    var K_WIN     = 'dv_winners';

    // ---------- Data Model ----------
    var players = load(K_PLAYERS, []);
    var stats   = load(K_STATS, {});
    var scheduleHin = load(K_S_HIN, []);
    var scheduleRueck = load(K_S_RUECK, []);
    var maxThrows = load(K_MAX, []);
    var winners   = load(K_WIN, []);

    // ---------- Helpers ----------
    function uid(){ return Math.random().toString(36).slice(2,9); }
    function save(key, val){ try{ localStorage.setItem(key, JSON.stringify(val)); }catch(e){ console.warn('localStorage save failed', e); } }
    function load(key, fallback){
      try{ var v = localStorage.getItem(key); return v ? JSON.parse(v) : fallback; }catch(e){ console.warn('localStorage load failed', e); return fallback; }
    }
    function escapeHtml(s){ return (s || '').replace(/[&<>\"]/g, function(c){ return {'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;'}[c]; }); }
    function playerById(id){ for(var i=0;i<players.length;i++){ if(players[i].id===id) return players[i]; } return null; }

    // ---------- Participants ----------
    var playersTableBody = document.querySelector('#playersTable tbody');
    var addPlayerBtn = document.getElementById('addPlayerBtn');
    var newPlayerInput = document.getElementById('newPlayerInput');
    var resetStatsBtn = document.getElementById('resetStatsBtn');

    if(addPlayerBtn){
      addPlayerBtn.addEventListener('click', function(){
        var name = (newPlayerInput && newPlayerInput.value ? newPlayerInput.value : '').trim();
        if(!name){ name = prompt('Neuen Spieler hinzuf√ºgen:'); }
        if(!name) return;
        var p = { id: uid(), name: name.trim() };
        players.push(p);
        stats[p.id] = stats[p.id] || {played:0, wins:0, losses:0};
        save(K_PLAYERS, players); save(K_STATS, stats);
        if(newPlayerInput) newPlayerInput.value='';
        renderPlayers(); refreshParticipantSelects(); renderSchedule();
      });
    }
    if(newPlayerInput){ newPlayerInput.addEventListener('keydown', function(e){ if(e.key==='Enter'){ addPlayerBtn && addPlayerBtn.click(); } }); }

    if(resetStatsBtn){
      resetStatsBtn.addEventListener('click', function(){
        if(!confirm('Wirklich alle Spieler-Ergebnisse (Gespielt/Siege/Niederlagen) zur√ºcksetzen?')) return;
        for(var id in stats){ stats[id] = {played:0, wins:0, losses:0}; }
        scheduleHin.forEach(function(m){ m.winnerId=null; });
        scheduleRueck.forEach(function(m){ m.winnerId=null; });
        save(K_STATS, stats); save(K_S_HIN, scheduleHin); save(K_S_RUECK, scheduleRueck);
        renderPlayers(); renderSchedule();
      });
    }

    function renderPlayers(){
      playersTableBody.innerHTML = '';
      players.forEach(function(p){
        var st = stats[p.id] || {played:0, wins:0, losses:0};
        var tr = document.createElement('tr');
        tr.innerHTML = '\n          <td class="pname">'+escapeHtml(p.name)+'</td>\n          <td>'+st.played+'</td>\n          <td><span class="pill">'+st.wins+'</span></td>\n          <td>'+st.losses+'</td>\n          <td class="row-actions">\n            <button class="secondary edit">‚úèÔ∏è Bearbeiten</button>\n            <button class="danger del">üóëÔ∏è L√∂schen</button>\n          </td>';
        var nameCell = tr.querySelector('.pname');
        var editBtn = tr.querySelector('.edit');
        var delBtn = tr.querySelector('.del');
        if(nameCell){ nameCell.addEventListener('dblclick', function(){ editPlayer(p.id); }); }
        if(editBtn){ editBtn.addEventListener('click', function(){ editPlayer(p.id); }); }
        if(delBtn){ delBtn.addEventListener('click', function(){ deletePlayer(p.id); }); }
        playersTableBody.appendChild(tr);
      });
    }
    function editPlayer(id){
      var p = playerById(id); if(!p) return;
      var n = prompt('Neuer Name:', p.name); if(!n) return;
      p.name = n.trim(); save(K_PLAYERS, players); renderPlayers(); refreshParticipantSelects(); renderSchedule();
    }
    function deletePlayer(id){
      if(!confirm('Diesen Spieler wirklich l√∂schen?')) return;
      players = players.filter(function(x){ return x.id!==id; }); delete stats[id];
      save(K_PLAYERS, players); save(K_STATS, stats);
      refreshParticipantSelects(); renderPlayers(); renderSchedule();
    }

    // ---------- Schedule ----------
    var genFairBtn = document.getElementById('genFairBtn');
    var shuffleFairBtn = document.getElementById('shuffleFairBtn');
    var hinBody = document.querySelector('#hinTable tbody');
    var rueckBody = document.querySelector('#rueckTable tbody');

    if(genFairBtn){
      genFairBtn.addEventListener('click', function(){
        if(players.length < 2){ alert('Mindestens 2 Spieler ben√∂tigt.'); return; }
        var rr = generateRoundRobinFair(players);
        scheduleHin = rr.hin; scheduleRueck = rr.rueck;
        save(K_S_HIN, scheduleHin); save(K_S_RUECK, scheduleRueck);
        renderSchedule();
      });
    }
    if(shuffleFairBtn){
      shuffleFairBtn.addEventListener('click', function(){
        scheduleHin = fairShuffle(scheduleHin);
        scheduleRueck = fairShuffle(scheduleRueck);
        save(K_S_HIN, scheduleHin); save(K_S_RUECK, scheduleRueck);
        renderSchedule();
      });
    }

    function renderSchedule(){
      hinBody.innerHTML=''; rueckBody.innerHTML='';
      scheduleHin.forEach(function(m,i){ hinBody.appendChild(matchRow(m,i,'hin')); });
      scheduleRueck.forEach(function(m,i){ rueckBody.appendChild(matchRow(m,i,'rueck')); });
      Array.from(hinBody.children).forEach(function(tr,i){ tr.querySelector('td').textContent = i+1; });
      Array.from(rueckBody.children).forEach(function(tr,i){ tr.querySelector('td').textContent = i+1; });
    }

    function matchRow(m, idx, phase){
      var tr=document.createElement('tr');
      var a = playerById(m.aId), b = playerById(m.bId);
      tr.innerHTML = '\n        <td>'+ (idx+1) +'</td>\n        <td>'+ escapeHtml(a && a.name || '-') +'</td>\n        <td>'+ escapeHtml(b && b.name || '-') +'</td>\n        <td>\n          <select class="winnerSel">\n            <option value="">‚Äî</option>\n            <option value="'+ m.aId +'">'+ escapeHtml(a && a.name || 'A') +'</option>\n            <option value="'+ m.bId +'">'+ escapeHtml(b && b.name || 'B') +'</option>\n          </select>\n        </td>';
      var sel=tr.querySelector('.winnerSel'); if(sel){ sel.value = m.winnerId || ''; sel.addEventListener('change', function(){ m.winnerId = sel.value || null; save(K_S_HIN, scheduleHin); save(K_S_RUECK, scheduleRueck); recomputeStats(); renderPlayers(); }); }

      // Drag & Drop
      tr.classList.add('draggable'); tr.setAttribute('draggable','true');
      tr.addEventListener('dragstart', function(e){ tr.classList.add('dragging'); e.dataTransfer.setData('text/plain', JSON.stringify({phase:phase, idx:idx})); });
      tr.addEventListener('dragend', function(){ tr.classList.remove('dragging'); });
      tr.addEventListener('dragover', function(e){ e.preventDefault(); });
      tr.addEventListener('drop', function(e){
        e.preventDefault(); var src = JSON.parse(e.dataTransfer.getData('text/plain') || '{}');
        if(src.phase !== phase) return; var arr = phase==='hin' ? scheduleHin : scheduleRueck;
        var from = src.idx, to = idx; if(from===to || from==null) return; var item = arr.splice(from,1)[0]; arr.splice(to,0,item);
        save(phase==='hin'?K_S_HIN:K_S_RUECK, arr); renderSchedule();
      });
      return tr;
    }

    function recomputeStats(){
      for(var id in stats){ stats[id] = {played:0, wins:0, losses:0}; }
      var all = scheduleHin.concat(scheduleRueck);
      all.forEach(function(m){ if(!m.aId || !m.bId) return; stats[m.aId].played++; stats[m.bId].played++; if(m.winnerId){ stats[m.winnerId].wins++; var loser = m.winnerId===m.aId? m.bId : m.aId; stats[loser].losses++; } });
      save(K_STATS, stats);
    }

    // ---------- Fairness Tools ----------
    function fairShuffle(arr){ var out=[], pool=arr.slice(); while(pool.length){ var last=out[out.length-1]; var lastSet= last? {a:last.aId,b:last.bId}:null; var i=0; if(last){ for(i=0;i<pool.length;i++){ var m=pool[i]; if(m.aId!==lastSet.a && m.aId!==lastSet.b && m.bId!==lastSet.a && m.bId!==lastSet.b){ break; } } if(i===pool.length) i=0; } var item=pool.splice(i,1)[0]; out.push(item); } return out; }
    function generateRoundRobinFair(pls){ var ids = pls.map(function(p){ return p.id; }); if(ids.length%2===1) ids.push('__BYE__'); var n=ids.length, rounds=n-1, half=n/2; var arr=ids.slice(); var hin=[], rueck=[]; for(var r=0;r<rounds;r++){ var pairs=[]; for(var i=0;i<half;i++){ var a=arr[i], b=arr[n-1-i]; if(a==='__BYE__'||b==='__BYE__') continue; pairs.push({aId:a,bId:b,winnerId:null}); } arr=[arr[0], arr[n-1]].concat(arr.slice(1,n-1)); hin=hin.concat(pairs); rueck=rueck.concat(pairs.map(function(m){ return {aId:m.bId,bId:m.aId,winnerId:null}; })); } return {hin:hin, rueck:rueck}; }

    // ---------- Widgets: H√∂chstwurf ----------
    var maxThrowDate = document.getElementById('maxThrowDate');
    var maxThrowPlayer = document.getElementById('maxThrowPlayer');
    var maxThrowValue = document.getElementById('maxThrowValue');
    var saveMaxThrowBtn = document.getElementById('saveMaxThrowBtn');
    var clearMaxThrowsBtn = document.getElementById('clearMaxThrowsBtn');
    var maxThrowsBody = document.querySelector('#maxThrowsTable tbody');

    if(saveMaxThrowBtn){ saveMaxThrowBtn.addEventListener('click', function(){ var date=maxThrowDate.value; var pid=maxThrowPlayer.value; var val=Number(maxThrowValue.value); if(!date||!pid||!(val>=0&&val<=1000)){ alert('Bitte Datum, Teilnehmer und Wurf (0‚Äì1000) korrekt eingeben.'); return; } maxThrows.unshift({date:date, playerId:pid, value:val}); save(K_MAX, maxThrows); maxThrowValue.value=''; renderMaxThrows(); }); }
    if(clearMaxThrowsBtn){ clearMaxThrowsBtn.addEventListener('click', function(){ if(!confirm('Alle H√∂chstwurf-Eintr√§ge wirklich l√∂schen?')) return; maxThrows=[]; save(K_MAX, maxThrows); renderMaxThrows(); }); }
    function renderMaxThrows(){ maxThrowsBody.innerHTML=''; maxThrows.slice(0,100).forEach(function(it){ var tr=document.createElement('tr'); var p=playerById(it.playerId); tr.innerHTML='<td>'+it.date+'</td><td>'+escapeHtml(p?p.name:'-')+'</td><td>'+it.value+'</td>'; maxThrowsBody.appendChild(tr); }); }

    // ---------- Widgets: Turnier-Gewinner ----------
    var winnerDate = document.getElementById('winnerDate');
    var winnerPlayer = document.getElementById('winnerPlayer');
    var saveWinnerBtn = document.getElementById('saveWinnerBtn');
    var clearWinnersBtn = document.getElementById('clearWinnersBtn');
    var winnersBody = document.querySelector('#winnersTable tbody');

    if(saveWinnerBtn){ saveWinnerBtn.addEventListener('click', function(){ var date=winnerDate.value; var pid=winnerPlayer.value; if(!date||!pid){ alert('Bitte Datum und Gewinner w√§hlen.'); return; } winners.unshift({date:date, playerId:pid}); save(K_WIN, winners); renderWinners(); }); }
    if(clearWinnersBtn){ clearWinnersBtn.addEventListener('click', function(){ if(!confirm('Alle Gewinner-Eintr√§ge wirklich l√∂schen?')) return; winners=[]; save(K_WIN, winners); renderWinners(); }); }
    function renderWinners(){ winnersBody.innerHTML=''; winners.slice(0,300).forEach(function(it){ var tr=document.createElement('tr'); var p=playerById(it.playerId); tr.innerHTML='<td>'+it.date+'</td><td>'+escapeHtml(p?p.name:'-')+'</td>'; winnersBody.appendChild(tr); }); }

    // ---------- Permalink (Option 2) ----------
    var permCreateBtn = document.getElementById('permCreateBtn');
    var permInfo = document.getElementById('permInfo');

    if(permCreateBtn){
      permCreateBtn.addEventListener('click', function(){
        var snapshot = { players:players, stats:stats, scheduleHin:scheduleHin, scheduleRueck:scheduleRueck, maxThrows:maxThrows, winners:winners };
        var encoded = encodeURIComponent(btoa(unescape(encodeURIComponent(JSON.stringify(snapshot)))));
        var url = location.origin + location.pathname + '#data=' + encoded;
        if(navigator.clipboard && navigator.clipboard.writeText){
          navigator.clipboard.writeText(url).then(function(){ permInfo.textContent = 'Permalink kopiert! √ñffne diesen Link auf einem anderen Ger√§t, um die Daten zu laden.'; setTimeout(function(){ permInfo.textContent=''; }, 5000); });
        } else {
          prompt('Permalink kopieren:', url);
        }
      });
    }

    (function(){
      var match = (location.hash||'').match(/#data=([^&]+)/);
      if(match){
        try{
          var decoded = JSON.parse(decodeURIComponent(escape(atob(decodeURIComponent(match[1])))));
          if(decoded && typeof decoded === 'object'){
            players = Array.isArray(decoded.players)? decoded.players : players;
            stats   = decoded.stats && typeof decoded.stats==='object' ? decoded.stats : stats;
            scheduleHin = Array.isArray(decoded.scheduleHin)? decoded.scheduleHin : scheduleHin;
            scheduleRueck = Array.isArray(decoded.scheduleRueck)? decoded.scheduleRueck : scheduleRueck;
            maxThrows = Array.isArray(decoded.maxThrows)? decoded.maxThrows : maxThrows;
            winners   = Array.isArray(decoded.winners)? decoded.winners : winners;
            save(K_PLAYERS, players); save(K_STATS, stats); save(K_S_HIN, scheduleHin); save(K_S_RUECK, scheduleRueck); save(K_MAX, maxThrows); save(K_WIN, winners);
          }
        }catch(e){ console.warn('Permalink decode failed', e); }
      }
    })();

    // ---------- Boot ----------
    function refreshParticipantSelects(){
      var opts = players.map(function(p){ return '<option value="'+p.id+'">'+escapeHtml(p.name)+'</option>'; }).join('');
      var maxSel = document.getElementById('maxThrowPlayer'); var winSel = document.getElementById('winnerPlayer');
      var prevMax=maxSel.value; maxSel.innerHTML = '<option value="">‚Äî Teilnehmer w√§hlen ‚Äî</option>' + opts; if(players.some(function(p){ return p.id===prevMax; })) maxSel.value=prevMax;
      var prevWin=winSel.value; winSel.innerHTML = '<option value="">‚Äî Teilnehmer w√§hlen ‚Äî</option>' + opts; if(players.some(function(p){ return p.id===prevWin; })) winSel.value=prevWin;
    }

    function boot(){
      players.forEach(function(p){ stats[p.id] = stats[p.id] || {played:0, wins:0, losses:0}; }); save(K_STATS, stats);
      var today = new Date().toISOString().slice(0,10); var maxDateEl=document.getElementById('maxThrowDate'); var winDateEl=document.getElementById('winnerDate'); if(maxDateEl) maxDateEl.value=today; if(winDateEl) winDateEl.value=today;
      renderPlayers(); renderSchedule(); renderMaxThrows(); renderWinners(); refreshParticipantSelects();
    }

    // Run boot after DOM ready
    if(document.readyState==='loading'){
      document.addEventListener('DOMContentLoaded', boot);
    } else { boot(); }
  </script>
</body>
</html>
