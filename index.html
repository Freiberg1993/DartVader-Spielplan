
<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DartVader Turnierplan ‚Äì Fairplay strikt (gespielt statt geplant)</title>
  <style>
    :root { --bg:#0f1221; --card:#1b1f36; --text:#e7e7f0; --muted:#b9bdd6; --accent:#7c4dff; --accent-2:#00c896; --warn:#ffb020; --danger:#ff5d5d; --grid:rgba(255,255,255,.08); }
    html,body{ background:var(--bg); color:var(--text); font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,'Helvetica Neue',Arial; }
    body{ margin:0; padding:2rem; }
    h1{ margin:0 0 .25rem 0; font-size:clamp(1.6rem,2.8vw,2.2rem);} .subtitle{ color:var(--muted); margin-bottom:1rem; }
    .badge{ display:inline-flex; gap:.5rem; background:#14243a; border:1px solid var(--grid); color:#9ad0ff; padding:.4rem .6rem; border-radius:8px; font-size:.95rem; }
    .container{ display:grid; grid-template-columns:1fr; gap:1rem;} @media(min-width:980px){ .container{ grid-template-columns:.9fr 1.1fr; }}
    .card{ background:var(--card); border:1px solid var(--grid); border-radius:14px; padding:1rem; box-shadow:0 6px 20px rgba(0,0,0,.25);} .card h2{ margin-top:0; font-size:1.25rem; }
    .toolbar{ display:flex; flex-wrap:wrap; gap:.5rem; margin-bottom:.75rem; }
    button{ background:var(--accent); color:#fff; border:none; border-radius:10px; padding:.55rem .9rem; font-weight:600; cursor:pointer; box-shadow:0 2px 6px rgba(0,0,0,.25);} .secondary{ background:#26355a; color:#e6e8f2;} .danger{ background:var(--danger);} button:disabled{ opacity:.55; cursor:not-allowed; }
    input[type=text]{ background:#141a2c; color:var(--text); border:1px solid var(--grid); border-radius:9px; padding:.5rem .6rem; width:100%; }
    table{ width:100%; border-collapse:collapse; } th,td{ border-bottom:1px solid var(--grid); padding:.5rem; text-align:left; } th{ color:#aeb4d8; font-weight:700; font-size:.95rem; } td{ font-size:.95rem; } tr:hover td{ background:rgba(255,255,255,.03); }
    .grid-2{ display:grid; grid-template-columns:1fr 1fr; gap:.75rem; }
    .hint{ margin-top:.5rem; color:#ffc27a; } .ok{ color:var(--accent-2);} .warn-text{ color:var(--warn);} select{ background:#141a2c; color:var(--text); border:1px solid var(--grid); border-radius:9px; padding:.35rem .45rem; }
    .footer{ margin-top:2rem; color:var(--muted); font-size:.9rem; }
  </style>
</head>
<body>
  
<!-- H√∂chster Tageswurf ‚Äì Widget -->
<div id="dv-tageswurf" class="dv-card" aria-labelledby="dv-title">
  <h3 id="dv-title" class="dv-title">H√∂chster Tageswurf</h3>

  <div class="dv-row">
    <label class="dv-field">
      <span class="dv-label">Teilnehmer</span>
      <select id="dv-player" class="dv-select" aria-label="Teilnehmer w√§hlen">
        <!-- wird per JS bef√ºllt -->
      </select>
    </label>

    <label class="dv-field">
      <span class="dv-label">Wurf</span>
      <input id="dv-score" class="dv-input" type="number" inputmode="numeric"
             min="1" step="1" placeholder="z.‚ÄØB. 180" aria-label="Tageswurf">
    </label>

    <button id="dv-save" class="dv-btn">Speichern</button>
  </div>

  <p id="dv-current" class="dv-current">Noch kein Eintrag.</p>
</

</div>
  <h1>DartVader Turnierplan</h1>
  <div class="subtitle">Fairplay-Regeln <span class="ok">STRIKT</span>: niemand spielt <strong>2√ó in Folge</strong>, niemand wartet <strong>3√ó in Folge</strong>. R√ºckrunde automatisch; Grenze konfliktfrei.</div>
  <div class="badge">‚ö°Ô∏è Fairplay aktiv</div>

  <div class="container">
    <div class="card">
      <h2>Teilnehmer</h2>
      <div class="toolbar">
        <input id="newName" type="text" placeholder="Spielername" />
        <button id="btnAdd">‚ûï Spieler hinzuf√ºgen</button>
        <button id="btnReset">üßπ Ergebnisse zur√ºcksetzen</button>
      </div>
      <table id="tblPlayers">
        <thead>
          <tr>
            <th>Name</th>
            <th>Gespielt</th>
            <th>Siege</th>
            <th>Niederlagen</th>
            <th>Aktion</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <div class="hint">Tipp: Namen doppelklicken zum Bearbeiten.</div>
    </div>

    <div class="card">
      <h2>Spielplan</h2>
      <div class="toolbar">
        <button id="btnFair">üîÑ Zuf√§llige Paarungen (FAIR, strikt)</button>
        <button class="secondary" id="btnShuffle">üîÄ Reihenfolge mischen (FAIR beibehalten)</button>
      </div>
      <div id="rulesInfo" class="hint"></div>
      <div class="grid-2">
        <div>
          <h3>Hinrunde</h3>
          <table id="tblHin">
            <thead>
              <tr>
                <th>#</th><th>Spieler A</th><th>Spieler B</th><th>Sieger</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <div>
          <h3>R√ºckrunde</h3>
          <table id="tblRueck">
            <thead>
              <tr>
                <th>#</th><th>Spieler A</th><th>Spieler B</th><th>Sieger</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <div class="footer">Made for DartVader ‚Ä¢ Lokale Speicherung aktiv</div>

<script>
const storeKey = 'dartvader_fair_v4';
let state = { players: [], matchesHin: [], matchesRueck: [] };
function id() { return Math.random().toString(36).slice(2,9); }
function byId(arr, idv) { return arr.find(x => x.id === idv); }
function nameOf(idv) { const p = byId(state.players, idv); return p ? p.name : '‚Äî'; }

function load() {
  const raw = localStorage.getItem(storeKey);
  if (raw) { try { state = JSON.parse(raw); } catch(e){} }
  else {
    state.players = [ {id:id(), name:'Kai'}, {id:id(), name:'Lena'}, {id:id(), name:'Tom'}, {id:id(), name:'Sara'} ];
  }
}
function save(){ localStorage.setItem(storeKey, JSON.stringify(state)); }

function renderPlayers(){
  const tbody = document.querySelector('#tblPlayers tbody'); tbody.innerHTML='';
  const stats = calcStats();
  state.players.forEach(p => {
    const tr = document.createElement('tr');
    const tdName = document.createElement('td'); tdName.textContent = p.name; tdName.title='Doppelklick zum Bearbeiten'; tdName.ondblclick = () => editPlayerName(p.id, tdName);
    const s = stats[p.id] || { games:0, wins:0, losses:0 };
    const tdGames = el('td', s.games);
    const tdWins = el('td', s.wins);
    const tdLoss = el('td', s.losses);
    const tdAct = document.createElement('td');
    const btnDel = document.createElement('button'); btnDel.textContent='üóëÔ∏è'; btnDel.className='danger'; btnDel.onclick = () => removePlayer(p.id);
    tdAct.appendChild(btnDel);
    tr.append(tdName, tdGames, tdWins, tdLoss, tdAct);
    tbody.appendChild(tr);
  });
}

function renderMatches(){
  const tbH = document.querySelector('#tblHin tbody');
  const tbR = document.querySelector('#tblRueck tbody');
  tbH.innerHTML=''; tbR.innerHTML='';
  state.matchesHin.forEach((m,i)=>tbH.appendChild(matchRow(m,i+1)));
  state.matchesRueck.forEach((m,i)=>tbR.appendChild(matchRow(m,i+1)));
  const full=[...state.matchesHin,...state.matchesRueck];
  const info=document.getElementById('rulesInfo');
  const v=validateSequence(full, state.players.map(p=>p.id));
  info.innerHTML = v.ok ? '<span class="ok">‚úîÔ∏é Fairplay erf√ºllt:</span> niemand spielt 2√ó in Folge, niemand wartet 3√ó in Folge.' : `<span class="warn-text">‚ö†Ô∏è</span> ${v.reason}`;
}

function matchRow(m, idx){
  const tr=document.createElement('tr');
  tr.appendChild(el('td', idx));
  tr.appendChild(el('td', nameOf(m.aId)));
  tr.appendChild(el('td', nameOf(m.bId)));
  const tdWin=document.createElement('td');
  const sel=document.createElement('select');
  const optNone=new Option('‚Äî','');
  const optA=new Option(nameOf(m.aId), m.aId);
  const optB=new Option(nameOf(m.bId), m.bId);
  sel.append(optNone,optA,optB);
  sel.value = m.winnerId || '';
  sel.onchange=(e)=>{ m.winnerId = e.target.value || null; save(); renderPlayers(); };
  tdWin.appendChild(sel);
  tr.appendChild(tdWin);
  return tr;
}
function el(tag,text){ const x=document.createElement(tag); x.textContent=text; return x; }

// ======== Spieler ========
function addPlayer(){ const inp=document.getElementById('newName'); const name=(inp.value||'').trim(); if(!name) return; state.players.push({id:id(), name}); inp.value=''; save(); renderPlayers(); }
function removePlayer(pid){ state.players = state.players.filter(p=>p.id!==pid); for(const m of [...state.matchesHin,...state.matchesRueck]){ if(m.winnerId===pid) m.winnerId=null; }
  state.matchesHin = state.matchesHin.filter(m=>m.aId!==pid && m.bId!==pid);
  state.matchesRueck = state.matchesRueck.filter(m=>m.aId!==pid && m.bId!==pid);
  save(); renderPlayers(); renderMatches(); }
function editPlayerName(pid, cell){ const p=byId(state.players,pid); if(!p) return; const input=document.createElement('input'); input.type='text'; input.value=p.name; input.style.width='100%'; cell.innerHTML=''; cell.appendChild(input); input.focus(); input.onblur=()=>{ p.name=(input.value||p.name).trim(); save(); renderPlayers(); renderMatches(); }; input.onkeydown=(e)=>{ if(e.key==='Enter') input.blur(); }; }
function resetResults(){ [...state.matchesHin,...state.matchesRueck].forEach(m=>m.winnerId=null); save(); renderPlayers(); renderMatches(); }

// ======== Stats (NEU: nur gespielte Matches) ========
function calcStats(){
  const stats={}; state.players.forEach(p=>stats[p.id]={ games:0, wins:0, losses:0 });
  for(const m of [...state.matchesHin, ...state.matchesRueck]){
    if(!m.aId || !m.bId) continue;
    if(m.winnerId){
      stats[m.aId].games++; stats[m.bId].games++;
      stats[m.winnerId].wins++;
      const loser = m.winnerId === m.aId ? m.bId : m.aId;
      stats[loser].losses++;
    }
  }
  return stats;
}

// ======== Paarungen & Fairplay ========
function generatePairs(pids){ const pairs=[]; for(let i=0;i<pids.length;i++){ for(let j=i+1;j<pids.length;j++){ pairs.push({ aId:pids[i], bId:pids[j] }); } } return pairs; }
function buildHinRueck(pids){ const hin=generatePairs(pids).map(x=>({id:id(), aId:x.aId, bId:x.bId, winnerId:null})); const rueck=generatePairs(pids).map(x=>({id:id(), aId:x.bId, bId:x.aId, winnerId:null})); return {hin, rueck}; }
function nonConsecutive(prev,next){ if(!prev) return true; const s=new Set([prev.aId, prev.bId]); return !s.has(next.aId) && !s.has(next.bId); }
function validateSequence(seq,pids){ for(let i=1;i<seq.length;i++){ if(!nonConsecutive(seq[i-1], seq[i])) return {ok:false, reason:`Versto√ü: ${nameOf(seq[i-1].aId)} oder ${nameOf(seq[i-1].bId)} spielt 2√ó in Folge (√úbergang ${i}‚Üí${i+1}).`}; }
  const gaps={}; pids.forEach(pid=>gaps[pid]=0); for(let i=0;i<seq.length;i++){ const m=seq[i]; const inv=new Set([m.aId,m.bId]); pids.forEach(pid=>{ gaps[pid] = inv.has(pid) ? 0 : gaps[pid]+1; }); for(const pid of pids){ if(gaps[pid]>=3) return {ok:false, reason:`Versto√ü: ${nameOf(pid)} wartet 3 Spiele in Folge (nach Spiel ${i+1}).`}; } } return {ok:true}; }
function planFairOrder(all,pids){ const n=all.length; const used=new Array(n).fill(false); const order=new Array(n); const gaps={}; pids.forEach(pid=>gaps[pid]=0);
  function score(prev,m){ if(!nonConsecutive(prev,m)) return -Infinity; let sc=0; for(const pid of pids){ const inv=(pid===m.aId||pid===m.bId); const g=inv?0:(gaps[pid]+1); if(g>=3) return -Infinity; sc+=g; } sc -= (gaps[m.aId]+gaps[m.bId])*2; return -sc; }
  function dfs(pos,prev){ if(pos===n) return true; const cand=[]; for(let i=0;i<n;i++) if(!used[i]) cand.push({idx:i,m:all[i],score:score(prev,all[i])}); cand.sort((a,b)=>b.score-a.score);
    for(const c of cand){ if(c.score===-Infinity) continue; const m=c.m; used[c.idx]=true; order[pos]=m; const backup={}; pids.forEach(pid=>backup[pid]=gaps[pid]); const inv=new Set([m.aId,m.bId]); for(const pid of pids){ gaps[pid] = inv.has(pid) ? 0 : (gaps[pid]+1); } let ok=true; for(const pid of pids){ if(gaps[pid]>=3){ ok=false; break; } } if(ok && dfs(pos+1,m)) return true; used[c.idx]=false; order[pos]=null; for(const pid of pids) gaps[pid]=backup[pid]; }
    return false; }
  return dfs(0,null) ? order : null; }

function applyFairSchedule(){ const pids=state.players.map(p=>p.id); if(pids.length<4){ state.matchesHin=[]; state.matchesRueck=[]; alert("Mindestens 4 Spieler erforderlich, um die Fairplay-Regeln strikt einzuhalten (mit 3 Spielern ist 'kein 2√ó in Folge' mathematisch unm√∂glich)."); renderMatches(); return; }
  const {hin,rueck}=buildHinRueck(pids); const combined=[...hin,...rueck]; const order=planFairOrder(combined,pids);
  if(!order){ alert('Kein strikter Fairplay-Plan m√∂glich mit der aktuellen Konstellation. Bitte Spieleranzahl pr√ºfen.'); state.matchesHin=hin; state.matchesRueck=rueck; }
  else { const hLen=hin.length; state.matchesHin=order.slice(0,hLen); state.matchesRueck=order.slice(hLen); }
  save(); renderMatches(); renderPlayers(); }

function shuffleKeepingFair(){ const pids=state.players.map(p=>p.id); const full=[...state.matchesHin,...state.matchesRueck]; for(let i=full.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [full[i],full[j]]=[full[j],full[i]]; } const order=planFairOrder(full,pids); if(!order){ alert('Shuffle konnte Fairplay nicht halten ‚Äì Plan bleibt unver√§ndert.'); return; } const hLen=state.matchesHin.length; state.matchesHin=order.slice(0,hLen); state.matchesRueck=order.slice(hLen); save(); renderMatches(); renderPlayers(); }

function bind(){ document.getElementById('btnAdd').onclick=addPlayer; document.getElementById('btnReset').onclick=resetResults; document.getElementById('btnFair').onclick=applyFairSchedule; document.getElementById('btnShuffle').onclick=shuffleKeepingFair; }
load(); bind(); renderPlayers(); renderMatches();
</script>
</body>
