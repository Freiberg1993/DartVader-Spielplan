<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DartVader Turnierplan ‚Äì Fairplay strikt (gespielt statt geplant)</title>
  <style>
    :root{
      --bg:#0f1419; --panel:#15202b; --panel-2:#1e2933; --text:#e6edf3; --muted:#94a3b8;
      --accent:#38bdf8; --danger:#ef4444; --table:#0b1220; --border:#203040;
    }
    *{box-sizing:border-box}
    body{margin:0; background:var(--bg); color:var(--text); font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif}
    header{padding:20px 24px; border-bottom:1px solid var(--border); background:linear-gradient(180deg, rgba(56,189,248,.15), transparent)}
    h1{margin:0 0 6px; font-size:28px}
    h2{margin:10px 0 0; font-size:22px}
    h3{margin:16px 0 8px; font-size:18px}
    h4{margin:14px 0 6px; font-size:16px}
    .grid{display:grid; grid-template-columns:1fr; gap:16px; padding:16px}
    @media(min-width:960px){.grid{grid-template-columns:1.1fr .9fr}}
    .card{background:var(--panel); border:1px solid var(--border); border-radius:12px; padding:16px}
    .muted{color:var(--muted)}
    button{background:var(--accent); color:#04243b; border:0; border-radius:8px; padding:8px 12px; font-weight:600; cursor:pointer}
    button.secondary{background:var(--panel-2); color:var(--text); border:1px solid #264055}
    button.danger{background:var(--danger); color:#fff}
    input, select{background:#0b1620; color:var(--text); border:1px solid #22364a; border-radius:8px; padding:8px; min-height:38px}
    input[type=number]{width:120px}
    input[type=date]{width:170px}
    table{width:100%; border-collapse:separate; border-spacing:0; margin-top:10px}
    th, td{padding:10px 12px; border-bottom:1px solid #1f2d3a}
    th{background:var(--table); text-align:left}
    tr:hover{background:#0f1b28}
    .row-actions{display:flex; gap:8px}
    .pill{display:inline-block; padding:4px 8px; border-radius:999px; background:#0b1620; border:1px solid #22364a}
    .flex{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .spacer{flex:1}
    .draggable{cursor:grab}
    .dragging{opacity:.55}
    footer{padding:16px; color:var(--muted)}
  </style>
</head>
<body>
  <header>
    <h1>DartVader Turnierplan ‚Äì Fairplay strikt (gespielt statt geplant)</h1>
    <h2>DartVader Turnierplan</h2>
    <p>Fairplay-Regeln STRIKT: niemand spielt 2√ó in Folge, niemand wartet 3√ó in Folge. R√ºckrunde automatisch; Grenze konfliktfrei.</p>
    <p class="muted">‚ö°Ô∏è Fairplay aktiv</p>
  </header>

  <main class="grid">
    <!-- Teilnehmer -->
    <section class="card">
      <h3>Teilnehmer</h3>
      <div class="flex">
        <button id="addPlayerBtn">‚ûï Spieler hinzuf√ºgen</button>
        <button id="resetStatsBtn" class="secondary">üßπ Ergebnisse zur√ºcksetzen</button>
        <input id="newPlayerInput" type="text" placeholder="Name" />
      </div>
      <p class="muted">Tipp: Namen doppelklicken zum Bearbeiten.</p>
      <table id="playersTable">
        <thead>
          <tr>
            <th>Name</th>
            <th>Gespielt</th>
            <th>Siege</th>
            <th>Niederlagen</th>
            <th>Aktion</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>

    <!-- Spielplan -->
    <section class="card">
      <h3>Spielplan</h3>
      <div class="flex">
        <button id="genFairBtn">üîÅ Zuf√§llige Paarungen (FAIR, strikt)</button>
        <button id="shuffleFairBtn" class="secondary">üîÄ Reihenfolge mischen (FAIR beibehalten)</button>
        <div class="spacer"></div>
        <span class="muted">(Zeilen in den Tabellen sind per Drag & Drop verschiebbar)</span>
      </div>

      <h4>Hinrunde</h4>
      <table id="hinTable">
        <thead>
          <tr>
            <th>#</th>
            <th>Spieler A</th>
            <th>Spieler B</th>
            <th>Sieger</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <h4>R√ºckrunde</h4>
      <table id="rueckTable">
        <thead>
          <tr>
            <th>#</th>
            <th>Spieler A</th>
            <th>Spieler B</th>
            <th>Sieger</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <p class="muted">Made for DartVader ‚Ä¢ Lokale Speicherung aktiv</p>
    </section>

    <!-- Tages-H√∂chstwurf -->
    <section class="card">
      <h3>üèÜ Tages‚ÄëH√∂chstwurf</h3>
      <p class="muted">Erfasse den h√∂chsten Wurf des Tages (0‚Äì1000). Eintr√§ge werden lokal im Browser gespeichert.</p>
      <div class="flex">
        <label>Datum<br><input id="maxThrowDate" type="date"></label>
        <label>Teilnehmer<br><select id="maxThrowPlayer"></select></label>
        <label>Wurf<br><input id="maxThrowValue" type="number" min="0" max="1000" step="1" placeholder="0‚Äì1000"></label>
        <button id="saveMaxThrowBtn">üíæ Speichern</button>
        <button id="clearMaxThrowsBtn" class="danger">üóëÔ∏è Alle l√∂schen</button>
      </div>
      <h4>Letzte Eintr√§ge</h4>
      <table id="maxThrowsTable">
        <thead>
          <tr>
            <th>Datum</th>
            <th>Teilnehmer</th>
            <th>Wurf</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>

    <!-- Turnier-Gewinner -->
    <section class="card">
      <h3>üìà Turnier‚ÄëGewinner‚ÄëStatistik</h3>
      <p class="muted">Trage ein, wer an welchem Datum das Turnier gewonnen hat. Optik & Bedienung wie beim H√∂chstwurf‚ÄëWidget.</p>
      <div class="flex">
        <label>Datum<br><input id="winnerDate" type="date"></label>
        <label>Gewinner<br><select id="winnerPlayer"></select></label>
        <button id="saveWinnerBtn">üíæ Speichern</button>
        <button id="clearWinnersBtn" class="danger">üóëÔ∏è Alle l√∂schen</button>
      </div>
      <h4>Historie</h4>
      <table id="winnersTable">
        <thead>
          <tr>
            <th>Datum</th>
            <th>Gewinner</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>
  </main>

  <footer>
    <span class="muted">¬© DartVader ‚Äì lokal gespeichert in deinem Browser.</span>
  </footer>

  <script>
    // ---------- Storage Keys ----------
    const K_PLAYERS = 'dv_players';
    const K_STATS   = 'dv_stats';
    const K_S_HIN   = 'dv_schedule_hin';
    const K_S_RUECK = 'dv_schedule_rueck';
    const K_MAX     = 'dv_maxthrows';
    const K_WIN     = 'dv_winners';

    // ---------- Data Model ----------
    let players = load(K_PLAYERS, []); // [ {id, name} ]
    let stats   = load(K_STATS, {});   // { id: {played, wins, losses} }
    let scheduleHin = load(K_S_HIN, []); // [ {aId, bId, winnerId|null} ]
    let scheduleRueck = load(K_S_RUECK, []);
    let maxThrows = load(K_MAX, []); // [ {date, playerId, value} ]
    let winners   = load(K_WIN, []); // [ {date, playerId} ]

    // ---------- Helpers ----------
    function uid(){ return Math.random().toString(36).slice(2,9); }
    function save(key, val){ localStorage.setItem(key, JSON.stringify(val)); }
    function load(key, fallback){ try{ return JSON.parse(localStorage.getItem(key)) ?? fallback }catch{ return fallback } }
    function escapeHtml(s){ return s?.replace(/[&<>"]/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])) || ''; }
    function playerById(id){ return players.find(p=>p.id===id); }

    // ---------- Participants ----------
    const playersTableBody = document.querySelector('#playersTable tbody');
    const addPlayerBtn = document.querySelector('#addPlayerBtn');
    const newPlayerInput = document.querySelector('#newPlayerInput');
    const resetStatsBtn = document.querySelector('#resetStatsBtn');

    addPlayerBtn.addEventListener('click', () => {
      let name = (newPlayerInput?.value || '').trim();
      if(!name){ name = prompt('Neuen Spieler hinzuf√ºgen:'); }
      if(!name) return;
      const p = { id: uid(), name: name.trim() };
      players.push(p);
      stats[p.id] = stats[p.id] || {played:0, wins:0, losses:0};
      save(K_PLAYERS, players); save(K_STATS, stats);
      if(newPlayerInput) newPlayerInput.value='';
      renderPlayers(); refreshParticipantSelects(); renderSchedule();
    });
    if(newPlayerInput){ newPlayerInput.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ addPlayerBtn.click(); }}); }

    resetStatsBtn.addEventListener('click', () => {
      if(!confirm('Wirklich alle Spieler-Ergebnisse (Gespielt/Siege/Niederlagen) zur√ºcksetzen?')) return;
      for(const id in stats){ stats[id] = {played:0, wins:0, losses:0}; }
      scheduleHin.forEach(m=>m.winnerId=null); scheduleRueck.forEach(m=>m.winnerId=null);
      save(K_STATS, stats); save(K_S_HIN, scheduleHin); save(K_S_RUECK, scheduleRueck);
      renderPlayers(); renderSchedule();
    });

    function renderPlayers(){
      playersTableBody.innerHTML = '';
      players.forEach(p => {
        const tr = document.createElement('tr');
        const st = stats[p.id] || {played:0, wins:0, losses:0};
        tr.innerHTML = `
          <td class="pname">${escapeHtml(p.name)}</td>
          <td>${st.played}</td>
          <td><span class="pill">${st.wins}</span></td>
          <td>${st.losses}</td>
          <td class="row-actions">
            <button class="secondary edit">‚úèÔ∏è Bearbeiten</button>
            <button class="danger del">üóëÔ∏è L√∂schen</button>
          </td>`;
        tr.querySelector('.pname').addEventListener('dblclick', ()=>editPlayer(p.id));
        tr.querySelector('.edit').addEventListener('click', ()=>editPlayer(p.id));
        tr.querySelector('.del').addEventListener('click', ()=>deletePlayer(p.id));
        playersTableBody.appendChild(tr);
      });
    }
    function editPlayer(id){
      const p = players.find(x=>x.id===id); if(!p) return;
      const n = prompt('Neuer Name:', p.name); if(!n) return;
      p.name = n.trim(); save(K_PLAYERS, players); renderPlayers(); refreshParticipantSelects(); renderSchedule();
    }
    function deletePlayer(id){
      if(!confirm('Diesen Spieler wirklich l√∂schen?')) return;
      players = players.filter(x=>x.id!==id); delete stats[id];
      save(K_PLAYERS, players); save(K_STATS, stats);
      refreshParticipantSelects(); renderPlayers(); renderSchedule();
    }

    // ---------- Schedule ----------
    const genFairBtn = document.querySelector('#genFairBtn');
    const shuffleFairBtn = document.querySelector('#shuffleFairBtn');
    const hinBody = document.querySelector('#hinTable tbody');
    const rueckBody = document.querySelector('#rueckTable tbody');

    genFairBtn.addEventListener('click', () => {
      if(players.length < 2){ alert('Mindestens 2 Spieler ben√∂tigt.'); return; }
      const {hin, rueck} = generateRoundRobinFair(players);
      scheduleHin = hin; scheduleRueck = rueck;
      save(K_S_HIN, scheduleHin); save(K_S_RUECK, scheduleRueck);
      renderSchedule();
    });
    shuffleFairBtn.addEventListener('click', () => {
      scheduleHin = fairShuffle(scheduleHin);
      scheduleRueck = fairShuffle(scheduleRueck);
      save(K_S_HIN, scheduleHin); save(K_S_RUECK, scheduleRueck);
      renderSchedule();
    });

    function renderSchedule(){
      hinBody.innerHTML=''; rueckBody.innerHTML='';
      scheduleHin.forEach((m,i)=> hinBody.appendChild(matchRow(m,i,'hin')));
      scheduleRueck.forEach((m,i)=> rueckBody.appendChild(matchRow(m,i,'rueck')));
      // # neu nummerieren
      Array.from(hinBody.children).forEach((tr,i)=> tr.querySelector('td').textContent = i+1);
      Array.from(rueckBody.children).forEach((tr,i)=> tr.querySelector('td').textContent = i+1);
    }

    function matchRow(m, idx, phase){
      const tr=document.createElement('tr');
      const a = playerById(m.aId), b = playerById(m.bId);
      tr.innerHTML = `
        <td>${idx+1}</td>
        <td>${escapeHtml(a?.name||'-')}</td>
        <td>${escapeHtml(b?.name||'-')}</td>
        <td>
          <select class="winnerSel">
            <option value="">‚Äî</option>
            <option value="${m.aId}">${escapeHtml(a?.name||'A')}</option>
            <option value="${m.bId}">${escapeHtml(b?.name||'B')}</option>
          </select>
        </td>`;
      const sel=tr.querySelector('.winnerSel'); sel.value = m.winnerId || '';
      sel.addEventListener('change', ()=>{ m.winnerId = sel.value || null; save(K_S_HIN, scheduleHin); save(K_S_RUECK, scheduleRueck); recomputeStats(); renderPlayers(); });

      // Drag & Drop
      tr.classList.add('draggable');
      tr.setAttribute('draggable','true');
      tr.addEventListener('dragstart', e=>{ tr.classList.add('dragging'); e.dataTransfer.setData('text/plain', JSON.stringify({phase, idx})); });
      tr.addEventListener('dragend', ()=> tr.classList.remove('dragging'));
      tr.addEventListener('dragover', e=> e.preventDefault());
      tr.addEventListener('drop', e=>{
        e.preventDefault(); const src = JSON.parse(e.dataTransfer.getData('text/plain'));
        if(src.phase !== phase) return; const arr = phase==='hin' ? scheduleHin : scheduleRueck;
        const from = src.idx, to = idx; if(from===to) return; const [item] = arr.splice(from,1); arr.splice(to,0,item);
        save(phase==='hin'?K_S_HIN:K_S_RUECK, arr); renderSchedule();
      });
      return tr;
    }

    function recomputeStats(){
      for(const id in stats){ stats[id] = {played:0, wins:0, losses:0}; }
      [...scheduleHin, ...scheduleRueck].forEach(m=>{
        if(!m.aId || !m.bId) return; stats[m.aId].played++; stats[m.bId].played++;
        if(m.winnerId){ stats[m.winnerId].wins++; const loser = m.winnerId===m.aId? m.bId : m.aId; stats[loser].losses++; }
      });
      save(K_STATS, stats);
    }

    // ---------- Fairness Tools ----------
    function fairShuffle(arr){
      const out=[]; const pool=arr.slice();
      while(pool.length){
        const last=out[out.length-1]; const lastSet = last ? new Set([last.aId,last.bId]) : new Set();
        let i = pool.findIndex(m => !(last && (lastSet.has(m.aId)||lastSet.has(m.bId))));
        if(i<0) i=0; out.push(pool.splice(i,1)[0]);
      }
      return out;
    }
    function generateRoundRobinFair(pls){
      const ids = pls.map(p=>p.id);
      if(ids.length%2===1) ids.push('__BYE__');
      const n=ids.length, rounds=n-1, half=n/2; let arr=ids.slice();
      const hin=[], rueck=[];
      for(let r=0;r<rounds;r++){
        const pairs=[]; for(let i=0;i<half;i++){ const a=arr[i], b=arr[n-1-i]; if(a==='__BYE__'||b==='__BYE__') continue; pairs.push({aId:a, bId:b, winnerId:null}); }
        arr=[arr[0], arr[n-1], ...arr.slice(1,n-1)];
        hin.push(...pairs); rueck.push(...pairs.map(m=>({aId:m.bId, bId:m.aId, winnerId:null})));
      }
      return {hin, rueck};
    }

    // ---------- Widgets: H√∂chstwurf ----------
    const maxThrowDate = document.querySelector('#maxThrowDate');
    const maxThrowPlayer = document.querySelector('#maxThrowPlayer');
    const maxThrowValue = document.querySelector('#maxThrowValue');
    const saveMaxThrowBtn = document.querySelector('#saveMaxThrowBtn');
    const clearMaxThrowsBtn = document.querySelector('#clearMaxThrowsBtn');
    const maxThrowsBody = document.querySelector('#maxThrowsTable tbody');

    saveMaxThrowBtn.addEventListener('click', ()=>{
      const date=maxThrowDate.value, pid=maxThrowPlayer.value, val=Number(maxThrowValue.value);
      if(!date || !pid || !(val>=0 && val<=1000)){ alert('Bitte Datum, Teilnehmer und Wurf (0‚Äì1000) korrekt eingeben.'); return; }
      maxThrows.unshift({date, playerId:pid, value:val}); save(K_MAX, maxThrows); maxThrowValue.value=''; renderMaxThrows();
    });
    clearMaxThrowsBtn.addEventListener('click', ()=>{ if(!confirm('Alle H√∂chstwurf-Eintr√§ge wirklich l√∂schen?')) return; maxThrows=[]; save(K_MAX, maxThrows); renderMaxThrows(); });
    function renderMaxThrows(){ maxThrowsBody.innerHTML=''; maxThrows.slice(0,100).forEach(it=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${it.date}</td><td>${escapeHtml(playerById(it.playerId)?.name||'-')}</td><td>${it.value}</td>`; maxThrowsBody.appendChild(tr); }); }

    // ---------- Widgets: Turnier-Gewinner ----------
    const winnerDate = document.querySelector('#winnerDate');
    const winnerPlayer = document.querySelector('#winnerPlayer');
    const saveWinnerBtn = document.querySelector('#saveWinnerBtn');
    const clearWinnersBtn = document.querySelector('#clearWinnersBtn');
    const winnersBody = document.querySelector('#winnersTable tbody');

    saveWinnerBtn.addEventListener('click', ()=>{
      const date=winnerDate.value, pid=winnerPlayer.value; if(!date||!pid){ alert('Bitte Datum und Gewinner w√§hlen.'); return; }
      winners.unshift({date, playerId:pid}); save(K_WIN, winners); renderWinners();
    });
    clearWinnersBtn.addEventListener('click', ()=>{ if(!confirm('Alle Gewinner-Eintr√§ge wirklich l√∂schen?')) return; winners=[]; save(K_WIN, winners); renderWinners(); });
    function renderWinners(){ winnersBody.innerHTML=''; winners.slice(0,300).forEach(it=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${it.date}</td><td>${escapeHtml(playerById(it.playerId)?.name||'-')}</td>`; winnersBody.appendChild(tr); }); }

    // ---------- Shared ----------
    function refreshParticipantSelects(){
      const opts = players.map(p=>`<option value="${p.id}">${escapeHtml(p.name)}</option>`).join('');
      const prevMax=maxThrowPlayer.value; maxThrowPlayer.innerHTML = `<option value="">‚Äî Teilnehmer w√§hlen ‚Äî</option>` + opts; if(players.some(p=>p.id===prevMax)) maxThrowPlayer.value=prevMax;
      const prevWin=winnerPlayer.value; winnerPlayer.innerHTML = `<option value="">‚Äî Teilnehmer w√§hlen ‚Äî</option>` + opts; if(players.some(p=>p.id===prevWin)) winnerPlayer.value=prevWin;
    }

    function boot(){
      players.forEach(p=>{ stats[p.id] = stats[p.id] || {played:0, wins:0, losses:0}; }); save(K_STATS, stats);
      const today = new Date().toISOString().slice(0,10); maxThrowDate.value=today; winnerDate.value=today;
      renderPlayers(); renderSchedule(); renderMaxThrows(); renderWinners(); refreshParticipantSelects();
    }
    boot();
  </script>
</body>
</html>
